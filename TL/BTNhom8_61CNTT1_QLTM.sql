/*			NHÓM 8 - QUẢN LÝ TRẠI MỘC "MỘC PHÚC"
PHAN TRẦN HỮU PHÚC	-	61136382
PHẠM MINH HOÀNG		-	61131788
LÊ VĂN THANH		-	61134348
NGUYỄN TRỌNG HIẾU	-	61133639
*/

/*Tạo bảng (Hoàng) */
CREATE DATABASE QLTM 

USE QLTM
GO

CREATE TABLE THOMOC (
	MATM VARCHAR(5) PRIMARY KEY,
	TENTM NVARCHAR(30) NOT NULL,
	NGAYSINH DATE NOT NULL,
	NGAYLAMVIEC DATE NOT NULL,
	DIACHI NVARCHAR(100) NOT NULL,
	SDT VARCHAR(20) NOT NULL,
	LUONG DECIMAL(10,2) NOT NULL,
	PHAI NVARCHAR(3) NOT NULL
)

CREATE TABLE KHACHHANG (
	MAKH VARCHAR(5) PRIMARY KEY,
	TENKH NVARCHAR(30) NOT NULL,
	DIACHI NVARCHAR(100) NOT NULL,
	SDT VARCHAR(20) NOT NULL,
	PHAI NVARCHAR(3) NOT NULL
)

CREATE TABLE NHACUNGCAPVT(
	MANCC VARCHAR(5) PRIMARY KEY,
	TENNCC NVARCHAR(30) NOT NULL,
	DIACHI NVARCHAR(100) NOT NULL,
	SDT VARCHAR(20) NOT NULL
)

CREATE TABLE VATTU (
	MAVT VARCHAR(5) PRIMARY KEY,
	TENVT NVARCHAR(30) NOT NULL,
	DVT NVARCHAR(10) NOT NULL,
	GIAVT DECIMAL(10,2) NOT NULL,
	MANCC VARCHAR(5) FOREIGN KEY REFERENCES NHACUNGCAPVT(MANCC)
)

CREATE TABLE LOAISP(
	MALSP VARCHAR(5) PRIMARY KEY,
	TENLOAISP NVARCHAR(10) NOT NULL
)

CREATE TABLE SANPHAM (
	MASP VARCHAR(5) PRIMARY KEY,
	TENSP NVARCHAR(20) NOT NULL,
	IMG VARCHAR(MAX),
	MOTA NVARCHAR(255),
	CHIEURONG_CM SMALLINT NOT NULL,
	CHIEUCAO_CM SMALLINT NOT NULL,
	GIASP DECIMAL(10,2) NOT NULL,
	MALSP VARCHAR(5) FOREIGN KEY REFERENCES LOAISP(MALSP)
)

CREATE TABLE PHANCONG (
	MATM VARCHAR(5) FOREIGN KEY REFERENCES THOMOC(MATM),
	MASP VARCHAR(5) FOREIGN KEY REFERENCES SANPHAM(MASP),
	THOIGIAN DECIMAL(5,1) NOT NULL,
	PRIMARY KEY (MATM, MASP)
)

CREATE TABLE VATTUTAOSP (
	MASP VARCHAR(5) FOREIGN KEY REFERENCES SANPHAM(MASP),
	MAVT VARCHAR(5) FOREIGN KEY REFERENCES VATTU(MAVT),
	SOLUONGVT DECIMAL(5,1) NOT NULL,
	PRIMARY KEY (MASP, MAVT)
)

CREATE TABLE DONDATSP (
	SOHD VARCHAR(10) PRIMARY KEY,
	MAKH VARCHAR(5) FOREIGN KEY REFERENCES KHACHHANG(MAKH),
	NGAYDAT DATE NOT NULL,
	NGAYGIAO DATE NOT NULL,
	NOIGIAO NVARCHAR(100)
)

CREATE TABLE CTDATSP (
	SOHD VARCHAR(10) FOREIGN KEY REFERENCES DONDATSP(SOHD),
	MASP VARCHAR(5) FOREIGN KEY REFERENCES SANPHAM(MASP),
	SOLUONG SMALLINT NOT NULL,
	PRIMARY KEY (SOHD, MASP)
)

/*Nhập dữ liệu (Phúc)*/
INSERT INTO THOMOC(MATM,TENTM,NGAYSINH,NGAYLAMVIEC,DIACHI,SDT,LUONG,PHAI) VALUES
('TM001',N'PHAN TRẦN HỮU PHÚC','2001/10/22','2021/11/01',N'56 KA CÙ LAO THƯỢNG, NHA TRANG','0708488401',5000000,'NAM'),
('TM002',N'NGUYỄN CAO CƯỜNG','1991/04/12','2015/10/10',N'TỔ 20 HÒN NGHÊ 2, NHA TRANG','0935123441',10000000,'NAM'),
('TM003',N'PHẠM BÁ TÍN','1995/02/24','2020/02/15',N'40 NGÕ NGỌC SƠN, VŨNG ĐÌNH, NHA TRANG','0703478407',5000000,'NAM'),
('TM004',N'PHAN QUANG','2000/09/23','2021/11/01',N'57 KA CÙ LAO THƯỢNG, NHA TRANG','0707468412',5000000,'NAM'),
('TM005',N'TRẦN CÔNG NHÂN','1991/01/06','2015/10/1',N'30 TÔN THẤT TÙNG, NHA TRANG','0708488401',10000000,'NAM')

INSERT INTO KHACHHANG(MAKH,TENKH,DIACHI,SDT,PHAI) VALUES
('KH001',N'PHẠM MINH HOÀNG',N'53 KA CÙ LAO TRUNG, NHA TRANG','0708378402','NAM'),
('KH002',N'NGUYỄN PHƯƠNG LAM',N'TỔ 10 HÒN NGHÊ 1, NHA TRANG','0946123441',N'NỮ'),
('KH003',N'LÊ VĂN THANH',N'105 NGUYỄN KHUYẾN, VĨNH HÃI, NHA TRANG','0743477407','NAM'),
('KH004',N'NGUYỄN TRỌNG HIẾU',N'40 ĐƯỜNG BIỆT THỰ, NHA TRANG','0707499432','NAM'),
('KH005',N'TRẦN THỊ QUỲNH TRÂM',N'23 KB CÙ LAO THƯỢNG, NHA TRANG','0908486404',N'NỮ')

INSERT INTO NHACUNGCAPVT(MANCC,TENNCC,DIACHI,SDT) VALUES 
('CC001',N'GỖ NHA TRANG','22 LÊ HỒNG PHONG, NHA TRANG','0905703521'),
('CC002',N'VẬT TƯ HỒNG HẢI','13 NGUYỄN KHUYẾN, VĨNH HẢI, NHA TRANG','0905703521'),
('CC003',N'TIỆM KÍNH, GƯƠNG PHAN BIỂU','26 NGUYỄN KHUYẾN, VĨNH HẢI, NHA TRANG','0905703522')

INSERT INTO VATTU(MAVT,TENVT,DVT,GIAVT,MANCC) VALUES
('VT001',N'VÁN ÉP OKAL',N'TẤM',250000,'CC001'),
('VT002',N'VÁN ÉP PLYWOOD',N'TẤM',260000,'CC001'),
('VT003',N'VÁN ÉP MDF',N'TẤM',240000,'CC001'),
('VT004',N'VÁN ÉP HDF',N'TẤM',250000,'CC001'),
('VT005',N'SƠN LÓT',N'LÍT',100000,'CC002'),
('VT006',N'SƠN PU CHỐNG THẤM',N'LÍT',100000,'CC002'),
('VT007',N'SƠN PU BÓNG MỜ',N'LÍT',100000,'CC002'),
('VT008',N'ĐINH',N'KILOGRAM',50000,'CC002'),
('VT009',N'GƯƠNG',N'MÉT',100000,'CC003'),
('VT010',N'KÍNH',N'MÉT',100000,'CC003')

INSERT INTO LOAISP(MALSP,TENLOAISP) VALUES
('LSP01',N'BÀN'),
('LSP02',N'GHẾ'),
('LSP03',N'TỦ'),
('LSP04',N'GIƯỜNG')

INSERT INTO SANPHAM(MASP,TENSP,IMG,MOTA,CHIEURONG_CM,CHIEUCAO_CM,GIASP,MALSP) VALUES
('SP001',N'BÀN LÀM VIỆC IKIA 3M','LINK IMG',N'MẶT BÀN 3 MÉT, BO TRÒN CÁC GÓC', 300 , 120 , 500000 ,'LSP01'),
('SP002',N'BÀN LÀM VIỆC IKIA 2M','LINK IMG',N'MẶT BÀN 2 MÉT, BO TRÒN CÁC GÓC', 200, 120 , 300000 ,'LSP01'),
('SP003',N'BÀN UỐNG CÀ PHÊ ORAN','LINK IMG',N'MẶT BÀN TRÒN, SƠN PU CHỐNG THẤM', 50 , 100 , 100000 ,'LSP01'),
('SP004',N'GHẾ LÀM VIỆC CỔ ĐIỂN','LINK IMG',N'SƠN CHỐNG THẤM, BO TRÒN CÁC GÓC CỦA MẶT GHẾ', 30 , 150 , 200000 ,'LSP02'),
('SP005',N'GHẾ UỐNG CÀ PHÊ ORAN','LINK IMG',N'MẶT GHẾ TRÒN, KHÔNG CÓ TỰA LƯNG, BO TRNF CÁC CHÂN', 20 , 50 , 90000 ,'LSP02'),
('SP006',N'GIƯỜNG NGỦ 2M','LINK IMG',N'GIƯỜNG DÀI 2 MÉT, SƠN BÓNG MỜ', 180 , 200 , 1000000 ,'LSP04'),
('SP007',N'GIƯỜNG NGỦ 3M','LINK IMG',N'GIƯỜNG DÀI 3 MÉT, SƠN BÓNG MỜ', 200 , 300 , 2000000 ,'LSP04'),
('SP008',N'TỦ QUẦN ÁO AKIRA','LINK IMG',N'SƠN PU CHỐNG THẤM, CÓ HAI CỬA, CÓ MỘT GƯƠNG Ở CỬA TRÁI', 160 , 230 , 1000000 ,'LSP03'),
('SP009',N'TỦ ĐỰNG RƯỢU','LINK IMG',N'SƠN PU CHỐNG THẤM, CÓ KÍNH Ở BỐN MẶT TỦ', 160 , 240 , 1400000 ,'LSP03')

INSERT INTO PHANCONG(MATM,MASP,THOIGIAN) VALUES
('TM001','SP001',8),
('TM002','SP002',7),
('TM003','SP003',6),
('TM004','SP004',7),
('TM005','SP005',5),
('TM001','SP006',16),
('TM002','SP006',16),
('TM003','SP007',17),
('TM004','SP007',17),
('TM005','SP008',20),
('TM004','SP008',20),
('TM002','SP009',14),
('TM003','SP009',14)

INSERT INTO VATTUTAOSP(MASP,MAVT,SOLUONGVT) VALUES
('SP001','VT008',0.5),
('SP001','VT002',1),
('SP001','VT005',1),
('SP001','VT006',1),
('SP002','VT008',0.4),
('SP002','VT001',0.8),
('SP002','VT005',1),
('SP002','VT006',1),
('SP003','VT008',0.3),
('SP003','VT003',0.4),
('SP003','VT005',0.5),
('SP003','VT006',0.5),
('SP004','VT008',0.3),
('SP004','VT002',0.5),
('SP004','VT005',0.5),
('SP004','VT006',0.5),
('SP005','VT008',0.3),
('SP005','VT003',0.3),
('SP005','VT005',0.5),
('SP005','VT006',0.5),
('SP006','VT008',0.7),
('SP006','VT004',2),
('SP006','VT005',1),
('SP006','VT007',1),
('SP007','VT008',1),
('SP007','VT004',2.2),
('SP007','VT005',1.2),
('SP007','VT006',1.2),
('SP008','VT008',1.3),
('SP008','VT002',2.5),
('SP008','VT005',1.5),
('SP008','VT006',1.5),
('SP008','VT009',2.2),
('SP009','VT008',1),
('SP009','VT002',1),
('SP009','VT005',1),
('SP009','VT006',1),
('SP009','VT010',8)

INSERT INTO DONDATSP(SOHD,MAKH,NGAYDAT,NGAYGIAO) VALUES
('HD001','KH001','8/10/2021','9/1/2021'),
('HD002','KH002','8/21/2021','9/15/2021'),
('HD003','KH003','7/10/2021','7/21/2021'),
('HD004','KH004','9/3/2021','9/30/2021'),
('HD005','KH005','6/26/2021','7/6/2021'),
('HD006','KH001','9/21/2021','10/15/2021'),
('HD007','KH002','10/30/2021','11/5/2021')

INSERT INTO CTDATSP(SOHD,MASP,SOLUONG) VALUES
('HD001','SP001',1),
('HD001','SP004',1),
('HD002','SP003',5),
('HD002','SP005',5),
('HD003','SP007',1),
('HD004','SP006',1),
('HD004','SP008',1),
('HD005','SP009',1),
('HD006','SP002',1),
('HD006','SP004',1),
('HD007','SP009',1)

-------------------------------------------------------------------------
/*a.Truy vấn đơn giản: 3 câu  (Thanh) */
/* Câu 1: Liệt kê các vật tư có giá lớn hơn 100000 */
SELECT *
FROM VATTU
WHERE GIAVT > 100000

/*Câu 2: Cho biết những thợ mộc có phái là nam và địa chỉ trên đường “CÙ LAO THƯỢNG”*/
SELECT MATM,TENTM 
FROM THOMOC
WHERE PHAI = 'NAM' AND DIACHI LIKE N'%CÙ LAO THƯỢNG%'

/*Câu 3: Cho biết những thợ mộc có ngày sinh trong năm 1991*/
SELECT *
FROM THOMOC
WHERE YEAR(NGAYSINH) = 1991

---------------------------------------------------------------------------------------
/*b.Truy vấn với Aggregate Functions: 7 câu   (Hoàng) */
--1.Thợ mộc nào của trại mộc làm được số lượng sản phẩm nhiều nhất và số lượng sản phẩm bán được 
--của những thợ mộc này là bao nhiêu.
SELECT TM.MATM,TM.TENTM,SUM(CT.SOLUONG) AS [SO LUONG SP]
FROM THOMOC TM JOIN PHANCONG PC ON TM.MATM=PC.MATM
join CTDATSP CT ON PC.MASP=CT.MASP
GROUP BY TM.MATM,TM.TENTM
HAVING SUM(CT.SOLUONG) >= ALL(SELECT SUM(CT1.SOLUONG) FROM PHANCONG PC1 JOIN CTDATSP CT1 ON PC1.MASP=CT1.MASP GROUP BY PC1.MATM)

--2.Cho biết thông tin khách hàng, và số tiền phải trả ứng với mỗi sản phẩm, theo thứ tự số tiền 
--phải trả tăng dần.
SELECT KH.TENKH, SUM(CT.SOLUONG*SP.GIASP) AS [SO TIEN PHAI TRA]
FROM KHACHHANG KH JOIN DONDATSP D ON KH.MAKH= D.MAKH 
JOIN CTDATSP CT ON D.SOHD=CT.SOHD
JOIN SANPHAM SP ON CT.MASP=SP.MASP
GROUP BY  KH.TENKH
ORDER BY SUM(CT.SOLUONG*SP.GIASP)

--3.cho biết số lượng khách hàng có địa chỉ tại nha trang đặt mua hàng
SELECT COUNT(*) AS [SO LUONG KHACH HANG]
FROM KHACHHANG KH JOIN DONDATSP D ON KH.MAKH= D.MAKH 
JOIN CTDATSP CT ON D.SOHD=CT.SOHD
WHERE KH.DIACHI LIKE '%NHA TRANG%'

--4. cho biết số tiền phải trả ứng với mỗi sản phẩm
SELECT SP.TENSP, SUM(SP.GIASP*CT.SOLUONG) AS [SO TIEN]
FROM SANPHAM SP JOIN CTDATSP CT ON SP.MASP=CT.MASP
GROUP BY SP.TENSP

--5. cho biết số sản phẩm của từng loại sản phẩm
SELECT L.TENLOAISP,L.MALSP, COUNT(S.MASP) AS [SO SP]
FROM LOAISP L JOIN SANPHAM S ON L.MALSP=S.MALSP
GROUP BY L.TENLOAISP,L.MALSP
--6. liệt kê số tiền phải trả của mỗi vật tư ứng với mỗi nhà cung cấp.
SELECT NCC.TENNCC,NCC.MANCC, SUM(VT.GIAVT*VP.SOLUONGVT) AS [SO TIEN PHAI TRA]
FROM NHACUNGCAPVT NCC JOIN VATTU VT ON NCC.MANCC=VT.MANCC
JOIN VATTUTAOSP VP ON VT.MAVT = VP.MAVT
GROUP BY NCC.TENNCC,NCC.MANCC

--7. cho biết số giờ làm việc của từng thợ mộc
SELECT TM.MATM,TM.TENTM,SUM(PC.THOIGIAN) AS [SO GIO LAM VC]
FROM THOMOC TM JOIN PHANCONG PC ON TM.MATM=PC.MATM
GROUP BY TM.MATM,TM.TENTM 

--8. Tính tổng số tiền thu được của từng khách hàng mua hàng.
SELECT KH.MAKH,KH.TENKH,SUM(CT.SOLUONG*SP.GIASP) AS [SỐ TIỀN THU]
FROM KHACHHANG KH JOIN DONDATSP D ON KH.MAKH= D.MAKH 
JOIN CTDATSP CT ON D.SOHD=CT.SOHD
JOIN SANPHAM SP ON CT.MASP=SP.MASP 
GROUP BY KH.MAKH,KH.TENKH

--9. đếm số sản phẩm của từng khách hàng được giao trong năm 2021
SELECT KH.TENKH,YEAR(D.NGAYGIAO) AS [NAM], COUNT(D.SOHD) AS [SO SAN PHAM]
FROM KHACHHANG KH JOIN DONDATSP D ON KH.MAKH= D.MAKH
WHERE YEAR(D.NGAYGIAO) = 2021
GROUP BY KH.TENKH,YEAR(D.NGAYGIAO)

--10. đếm số lượng vật tư cần có để tạo nên từng sản phẩm
SELECT SP.TENSP, COUNT(VT.MAVT) AS [SỐ VT]
FROM VATTUTAOSP VT JOIN SANPHAM SP ON VT.MASP=SP.MASP
GROUP BY SP.TENSP

--------------------------------------------------------------------------------------
/*c.Truy vấn với mệnh đề having: 5 câu   (Hiếu) */
--1: Cho biết những thợ mộc tham gia làm từ 10 sản phẩm trở lên
SELECT PC.MATM, TENTM, COUNT(1) AS 'SO LUONG SP'
FROM PHANCONG PC JOIN THOMOC TM ON PC.MATM=TM.MATM
GROUP BY PC.MATM, TENTM
HAVING COUNT(1) > 10

--2: Hiển thị thông tin nhà cung cấp (mã, tên) cung cấp ít loại vật tư nhất
SELECT VT.MANCC, TENNCC, COUNT(MAVT) AS 'SO LOAI VT'
FROM VATTU VT JOIN NHACUNGCAPVT NCC ON VT.MANCC=NCC.MANCC
GROUP BY VT.MANCC, TENNCC
HAVING COUNT(MAVT) <= ALL (
		SELECT COUNT(MAVT)
		FROM VATTU
		GROUP BY MANCC
)

--3: Liệt kê tên những loại sản phẩm có nhiều sản phẩm nhất
SELECT TENLOAISP, COUNT(MASP) AS 'SO LUONG SP'
FROM SANPHAM SP JOIN LOAISP LSP ON SP.MALSP=LSP.MALSP
GROUP BY TENLOAISP
HAVING COUNT(MASP) >= ALL (
		SELECT COUNT(MASP)
		FROM SANPHAM
		GROUP BY MALSP
)

--4: Liệt kê tên các sản phẩm có giá gốc (tổng tiền của vật tư tạo sản phẩm) 
--từ 300000đ - 500000đ
SELECT TENSP, SUM(GIAVT*SOLUONGVT) AS 'GIA GOC'
FROM VATTUTAOSP VTSP JOIN SANPHAM SP ON VTSP.MASP=SP.MASP
					JOIN VATTU VT ON VTSP.MAVT=VT.MAVT
GROUP BY TENSP
HAVING SUM(GIAVT*SOLUONGVT) BETWEEN 300000 AND 500000

--5: Hiển thị thông tin khách hàng (mã, tên, số lượng sản phẩm) đặt nhiều hơn 2 sản phẩm
SELECT DD.MAKH, TENKH, SUM(CT.SOLUONG) AS 'SO LUONG SP'
FROM DONDATSP DD JOIN KHACHHANG KH ON DD.MAKH=KH.MAKH
				JOIN CTDATSP CT ON DD.SOHD=CT.SOHD
GROUP BY DD.MAKH, TENKH
HAVING SUM(CT.SOLUONG) > 2


--------------------------------------------------------------------------------------
/*d.Truy vấn lớn nhất, nhỏ nhất: 3 câu   (Thanh) */
/*1: Cho biết tên vật tư có giá trị vật tư lớn nhất */
SELECT TENVT
FROM VATTU
WHERE GIAVT = (SELECT MAX(GIAVT) FROM VATTU)

/*2: Cho biết khách hàng có ít đơn đặt hàng nhất trong năm 2021*/
SELECT DD.MAKH,TENKH
FROM DONDATSP DD JOIN KHACHHANG KH ON DD.MAKH=KH.MAKH
WHERE YEAR(NGAYDAT) = 2021
GROUP BY DD.MAKH,TENKH
HAVING COUNT(SOHD) <= ALL (
		SELECT COUNT(SOHD) 
		FROM DONDATSP 
		WHERE YEAR(NGAYDAT) = 2021 
		GROUP BY MAKH
)

/*3: Cho biết thông tin thợ mộc tạo ra sản phẩm tốn nhiều thời gian nhất. Gồm mã và tên */
SELECT PC.MATM, TENTM
FROM PHANCONG PC JOIN THOMOC TM ON PC.MATM=TM.MATM
WHERE PC.THOIGIAN>=(SELECT MAX(THOIGIAN) FROM PHANCONG PC)

---------------------------------------------------------------------------------------
/*e.Truy vấn Không/chưa có: (Not In và left/right join): 7 câu   (Phúc) */
/*1. Những loại sản phẩm nào chưa từng được khách hàng đặt làm?*/
SELECT TENLOAISP
FROM LOAISP
WHERE MALSP NOT IN (
		SELECT DISTINCT MALSP
		FROM CTDATSP CT LEFT JOIN SANPHAM SP ON CT.MASP=SP.MASP
)

/*2. Thông tin của những thợ mộc nào chưa từng được phân công làm bất kỳ một sản phẩm nào?*/
SELECT *
FROM THOMOC
WHERE MATM NOT IN (
		SELECT DISTINCT MATM
		FROM PHANCONG
)

/*3. Những loại sản phẩm nào hiện không có bất kỳ sản phẩm nào?.*/
SELECT TENLOAISP
FROM LOAISP
WHERE MALSP NOT IN (
		SELECT DISTINCT MALSP
		FROM SANPHAM
)

/*4. Những khách hàng nào không đặt bất kỳ sản phẩm nào trong năm 2020 ?*/
SELECT TENKH
FROM KHACHHANG
WHERE MAKH NOT IN (
		SELECT DISTINCT MAKH
		FROM DONDATSP
		WHERE YEAR(NGAYDAT) = 2020
)

/*5. Những nhà cung cấp nào không cung cấp vật tư để làm sản phẩm thuộc loại sản phẩm 'Bàn' hoặc 'Ghế'.*/
SELECT MANCC, TENNCC
FROM NHACUNGCAPVT
WHERE MANCC NOT IN (
		SELECT MANCC
		FROM SANPHAM SP LEFT JOIN VATTUTAOSP VTSP ON SP.MASP=VTSP.MASP
						LEFT JOIN VATTU VT ON VTSP.MAVT=VT.MAVT
						LEFT JOIN LOAISP LSP ON SP.MALSP=LSP.MALSP
		WHERE TENLOAISP LIKE N'BÀN' OR TENLOAISP LIKE N'GHẾ'
)

/*6. Cho biết các thợ mộc chưa làm sản phẩm thuộc loại sản phẩm ‘GIƯỜNG’?*/
SELECT TENTM
FROM THOMOC
WHERE MATM NOT IN (
		SELECT DISTINCT MATM
		FROM PHANCONG PC RIGHT JOIN SANPHAM SP ON PC.MASP=SP.MASP
						RIGHT JOIN LOAISP LSP ON SP.MALSP=LSP.MALSP
		WHERE TENLOAISP = N'GIƯỜNG'
)

/*7. Cho biết tên vật tư không được sử dụng để làm bất kỳ sản phẩm nào ?*/
SELECT TENVT
FROM VATTU
WHERE MAVT NOT IN (
		SELECT MAVT
		FROM VATTUTAOSP
)

----------------------------------------------------------------------------------
/*f.Truy vấn Hợp/Giao/Trừ: 3 câu   (Hoàng) */
--JOIN tìm những thợ mộc làm sp có masp là: SP008 HOẶC SP007
SELECT TM.MATM,TM.TENTM 
FROM THOMOC TM JOIN PHANCONG PC ON TM.MATM=PC.MATM
WHERE PC.MASP = 'SP007'
UNION
SELECT TM.MATM,TM.TENTM 
FROM THOMOC TM JOIN PHANCONG PC ON TM.MATM=PC.MATM
WHERE PC.MASP = 'SP008'

--INTERSECT tìm những thợ mộc làm sp có masp là: SP008 VÀ SP007
SELECT TM.MATM,TM.TENTM 
FROM THOMOC TM JOIN PHANCONG PC ON TM.MATM=PC.MATM
WHERE PC.MASP = 'SP007'
INTERSECT
SELECT TM.MATM,TM.TENTM 
FROM THOMOC TM JOIN PHANCONG PC ON TM.MATM=PC.MATM
WHERE PC.MASP = 'SP008'

--EXCEPT tìm những vật tư tạo nên sp có mã sp là SP009
SELECT MAVT
FROM VATTUTAOSP 
EXCEPT
SELECT MAVT
FROM VATTUTAOSP
WHERE MASP = 'SP009'

-------------------------------------------------------------------------
/*g.Truy vấn Update, Delete: 7 câu (Hiếu 3 câu update, Thanh 4 câu delete) */
--1: Đổi tên của thợ mộc tên "Phạm Bá Tín" thành "Phạm Bá Toàn"
UPDATE THOMOC
SET TENTM = N'PHẠM BÁ TOÀN'
WHERE MATM = 'TM001'

--2: Cập nhật giá của sản phẩm có mã là SP005 thành 100000đ
UPDATE SANPHAM
SET GIASP = 100000
WHERE MASP = 'SP005'

--3: Tăng 20% lương cho toàn bộ thợ mộc có thời gian làm việc nhiều hơn 100 giờ (thời tạo ra các sản phẩm)
UPDATE THOMOC
SET LUONG = LUONG + LUONG*0.2
WHERE MATM IN (
		SELECT MATM
		FROM PHANCONG
		GROUP BY MATM
		HAVING SUM(THOIGIAN) > 100
)

/* 4: Xóa tất cả khách hàng không có đơn đặt hàng nào*/
DELETE FROM KHACHHANG
WHERE MAKH NOT IN (
		SELECT DISTINCT MAKH
		FROM DONDATSP
)

/* 5: Xóa những vật tư do nhà cung cấp 'TIỆM KÍNH, GƯƠNG PHAN BIỂU' cung cấp */
DELETE FROM VATTU 
WHERE MANCC = (
		SELECT MANCC
		FROM NHACUNGCAPVT
		WHERE TENNCC LIKE N'TIỆM KÍNH, GƯƠNG PHAN BIỂU'
)

/* 6: Xóa những đơn đặt sản phẩm trước tháng 3 năm 2021 ra khỏi cơ sở dữ liệu */
DELETE FROM DONDATSP 
WHERE MONTH(NGAYDAT) < 3 AND YEAR(NGAYDAT) = 2021

/* 7:  Xóa khỏi bảng LOAISP những loại sản phẩm hiện không có sản phẩm */
DELETE FROM LOAISP 
WHERE MALSP NOT IN (
		SELECT DISTINCT MALSP 
		FROM SANPHAM
)

--------------------------------------------------------------------------------------------------------
/*Tạo ít nhất 5 thủ tục/hàm và 3 trigger   (Phúc)  */

/*1. Thủ tục thêm một thợ mộc vào bảng thợ mộc*/
CREATE PROC SP_THEM_THOMOC 
	@MATM VARCHAR(5),
	@TENTM NVARCHAR(30),
	@NGAYSINH DATE,
	@NGAYLAMVIEC DATE,
	@DIACHI NVARCHAR(50),
	@SDT VARCHAR(20),
	@LUONG DECIMAL(10,2),
	@PHAI NVARCHAR(3)
AS
BEGIN
	INSERT INTO THOMOC VALUES
	(@MATM,@TENTM,@NGAYSINH,@NGAYLAMVIEC,@DIACHI,@SDT,@LUONG,@PHAI)
END
EXEC THEM_THOMOC 'TM007',N'NGUYỄN THỊ BÍCH','2/15/1991','12/24/2016',N'30 TÔN THẤT TÙNG, NHA TRANG','0120734521',5000000,N'NỮ'

/*2. Thủ tục tăng lương cho tất cả thợ mộc theo phần trăm truyền vào*/
CREATE PROC SP_TANGLUONGTHEOPHANTRAM
	@PHAMTRAM SMALLINT
AS
BEGIN
	UPDATE THOMOC
	SET LUONG = LUONG + LUONG*(CONVERT(FLOAT,@PHAMTRAM) / CONVERT(FLOAT,100))
END 
EXEC TANGLUONGTHEOPHANTRAM 20


/*3. Thủ tục sửa địa chỉ nơi nhận hàng (nhập vào SOHD và địa chỉ nhận hàng mới)*/
CREATE PROC SP_NOIGIAOMOI
	@SOHD VARCHAR(10),
	@NOINHANMOI NVARCHAR(50)
AS
BEGIN
	IF NOT EXISTS (SELECT * FROM DONDATSP WHERE SOHD=@SOHD)
		PRINT('DON DAT HANG KHONG TON TAI')
	ELSE
		UPDATE DONDATSP
		SET NOIGIAO = @NOINHANMOI
		WHERE SOHD = @SOHD
END
EXEC NOIGIAOMOI 'HD001',N'40 NGÕ NGỌC SƠN, HÒN NGHÊ 2, NHA TRANG' 
--------------------------------------------------------------------------------
/*4. Hàm tính giá gốc của sản phẩm (tham số là MASP) từ giá của các vật tư tạo nên sản phẩm đó*/
CREATE FUNCTION FUNC_GIAGOCSP(@MASP VARCHAR(5))
RETURNS DECIMAL(10,2)
AS
BEGIN
	DECLARE @RESULT DECIMAL(10,2)
	SELECT @RESULT = SUM(GIAVT*SOLUONGVT)
	FROM VATTUTAOSP VTSP JOIN VATTU VT ON VTSP.MAVT=VT.MAVT
	WHERE MASP = @MASP
	RETURN @RESULT
END
SELECT dbo.FUNC_GIAGOCSP('SP001') AS 'GIA GOC SP'

/*5. Hàm trả về số năm làm việc của thợ mộc( tham số là MATM)*/
CREATE FUNCTION FUNC_THAMNIEN_LV(@MATM VARCHAR(5))
RETURNS TINYINT
AS
BEGIN
	DECLARE @THAMNIEN TINYINT
	SELECT @THAMNIEN = DATEDIFF(YEAR,NGAYLAMVIEC,GETDATE())
	FROM THOMOC
	WHERE MATM = @MATM
	RETURN @THAMNIEN
END
SELECT dbo.FUNC_THAMNIEN_LV('TM002') AS 'THAM NIEN' 
----------------------------------------------------------------
/*6. Trigger ràng buộc tuổi của thợ mộc phải nằm trong khoảng từ 18 đến 50*/
CREATE TRIGGER TG_TUOITM ON THOMOC
FOR INSERT, UPDATE
AS
BEGIN
		IF EXISTS (
			SELECT *
			FROM INSERTED I
			WHERE DATEDIFF(YEAR, I.NGAYSINH, GETDATE()) < 18 
				OR DATEDIFF(YEAR, I.NGAYSINH, GETDATE()) > 50 
		)
		BEGIN
			RAISERROR('TUOI CUA THO MOC KHONG NAM TU 18 DEN 50 TUOI',16,1)
			ROLLBACK TRAN
		END
END

INSERT INTO THOMOC VALUES
('TM007',N'TRẦN NHÂN QUYỀN','2006/01/06','2015/10/1',N'123 TÔN THẤT TÙNG, NHA TRANG','0708488409',10000000,'NAM')

UPDATE THOMOC
SET NGAYSINH = '10/22/2021'
WHERE MATM = 'TM001'

/*7. Trigger ràng buộc ngày giao hàng phải sau ngày đặt hàng và 
không trễ quá 3 tháng kể từ ngày đặt hàng*/
CREATE TRIGGER TG_THOIGIAN_DONDATSP ON DONDATSP
FOR INSERT, UPDATE
AS
BEGIN
		IF EXISTS (
			SELECT *
			FROM INSERTED I
			WHERE DATEDIFF(DAY, I.NGAYDAT, I.NGAYGIAO) < 1
				OR DATEDIFF(MONTH, I.NGAYDAT, I.NGAYGIAO) > 3
		)
		BEGIN
			RAISERROR(N'NGÀY GIAO HÀNG PHẢI SAU NGÀY ĐẶT HÀNG VÀ KHÔNG ĐƯỢC TRỄ QUÁ 3 THÁNG',16,1)
			ROLLBACK TRAN
		END
END

INSERT INTO DONDATSP(SOHD,MAKH,NGAYDAT,NGAYGIAO) VALUES
('HD008','KH002','12/30/2021','11/5/2021')

-- VD SỬA TRÊN BẢNG GHI ('HD001','KH001','8/10/2021','9/1/2021')
UPDATE DONDATSP
SET NGAYDAT = '7/10/2020'
WHERE SOHD = 'HD001'

UPDATE DONDATSP
SET NGAYGIAO = '7/1/2021'
WHERE SOHD = 'HD001'

/*8. Trigger ràng buộc nơi giao hàng phải nằm tại thành phố Nha Trang*/
CREATE TRIGGER TG_NOIGIAOHANG ON DONDATSP
FOR INSERT, UPDATE
AS
BEGIN
	IF EXISTS (
		SELECT *
		FROM INSERTED I
		WHERE I.NOIGIAO NOT LIKE N'%NHA TRANG%'
	) 
	BEGIN
		RAISERROR(N'NƠI GIAO HÀNG PHẢI NẰM TẠI THÀNH PHỐ NHA TRANG',16,1)
		ROLLBACK TRAN
	END
END

INSERT INTO DONDATSP(SOHD,MAKH,NGAYDAT,NGAYGIAO,NOIGIAO) VALUES
('HD009','KH001','8/10/2021','9/1/2021',N'22 TRỊNH MINH THẾ, NINH HÒA, KHÁNH HÒA')


--------------------------------------------------------------------------------------
/*Tạo 3 người dùng và cấp quyền cho mỗi người dùng với các quyền khác nhau.  (Phúc) */
CREATE USER QLTM_ADMIN FOR LOGIN QLTMadmin
CREATE USER THOMOC FOR LOGIN QLTM_ThoMoc
CREATE USER QUANLY FOR LOGIN QLTM_QuanLy

/*Thợ mộc có thể xem và cập nhật thông tin trên bảng THOMOC*/
GRANT SELECT, UPDATE
ON THOMOC
TO THOMOC

/*Thợ mộc có thể xem mình được phân công làm sản phẩm nào
trên bảng PHANCONG*/
GRANT SELECT
ON PHANCONG
TO THOMOC

/*Thợ mộc có thể xem vật tư để làm sản phẩm mình được phân công
trên bảng VATTUTAOSP*/
GRANT SELECT
ON VATTUTAOSP
TO THOMOC

/*Người quản lý có thể xem,thêm,sửa,xóa trên các bảng
THOMOC, KHACHHANG, NHACUNGCAPVT, VATTU, LOAISP, PHANCONG,
VATTUTAOSP*/
GRANT SELECT, INSERT, UPDATE, DELETE
ON THOMOC
TO QUANLY
GRANT SELECT, INSERT, UPDATE, DELETE
ON KHACHHANG
TO QUANLY
GRANT SELECT, INSERT, UPDATE, DELETE
ON NHACUNGCAPVT
TO QUANLY
GRANT SELECT, INSERT, UPDATE, DELETE
ON VATTU
TO QUANLY
GRANT SELECT, INSERT, UPDATE, DELETE
ON LOAISP
TO QUANLY
GRANT SELECT, INSERT, UPDATE, DELETE
ON PHANCONG
TO QUANLY
GRANT SELECT, INSERT, UPDATE, DELETE
ON VATTUTAOSP
TO QUANLY

/*Quản lý có quyền xem, thêm trên bảng DONDATSP,
CTDATSP*/
GRANT SELECT, INSERT
ON DONDATSP
TO QUANLY
GRANT SELECT, INSERT
ON CTDATSP
TO QUANLY

/*Admim có toàn quyền trên CSDL QLTM*/
GRANT ALL
ON QLTM
TO QLTM_ADMIN